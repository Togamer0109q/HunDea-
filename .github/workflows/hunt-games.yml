name: HunDea v3 - Professional Gaming Deals Hunter

on:
  schedule:
    # Se ejecuta cada 3 horas empezando a las 12:00 PM Colombia
    # Horario Colombia: 12PM, 3PM, 6PM, 9PM, 12AM, 3AM, 6AM, 9AM
    # Horario UTC: 5PM, 8PM, 11PM, 2AM, 5AM, 8AM, 11AM, 2PM
    - cron: '0 2,5,8,11,14,17,20,23 * * *'
  
  # Tambi√©n permite ejecuci√≥n manual desde GitHub
  workflow_dispatch:

jobs:
  hunt-free-games:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: üêç Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üì¶ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements_v3.txt
    
    - name: üîß Crear config.json (v3)
      env:
        WEBHOOK_PREMIUM: ${{ secrets.DISCORD_WEBHOOK }}
        WEBHOOK_BAJOS: ${{ secrets.DISCORD_WEBHOOK2 }}
        WEBHOOK_WEEKENDS: ${{ secrets.DISCORD_WEBHOOK3 }}
        WEBHOOK_DEALS: ${{ secrets.HUN_DEA_DESCUENTOS }}
        WEBHOOK_STATUS: ${{ secrets.DISCORD_WEBHOOK_STATUS }}
        RAWG_KEY: ${{ secrets.RAWG_API_KEY }}
        ITAD_KEY: ${{ secrets.ITAD_API_KEY }}
        GGDEALS_KEY: ${{ secrets.GGDEALS_API_KEY }}
        GGDEALS_REGION: ${{ secrets.GGDEALS_REGION }}
      run: |
        python3 << 'PYTHON_SCRIPT'
        import json
        import os

        with open('config_v3.example.json', 'r') as f:
            config = json.load(f)

        webhooks = config.setdefault("webhooks", {})
        webhooks.update({
            "pc_premium": os.environ.get('WEBHOOK_PREMIUM', ''),
            "pc_deals": os.environ.get('WEBHOOK_DEALS', ''),
            "pc_weekends": os.environ.get('WEBHOOK_WEEKENDS', ''),
            "pc_indie": os.environ.get('WEBHOOK_BAJOS', ''),
            "free_weekends": os.environ.get('WEBHOOK_WEEKENDS', '')
        })

        apis = config.setdefault("apis", {})
        rawg_key = os.environ.get('RAWG_KEY', '')
        if rawg_key:
            apis["rawg"] = rawg_key

        itad_key = os.environ.get('ITAD_KEY', '')
        if itad_key:
            apis["itad"] = itad_key

        ggdeals_key = os.environ.get('GGDEALS_KEY', '')
        if ggdeals_key:
            apis["ggdeals"] = ggdeals_key

        ggdeals_region = os.environ.get('GGDEALS_REGION', '')
        if ggdeals_region:
            apis["ggdeals_region"] = ggdeals_region.lower()

        notifiers = config.setdefault("notifiers", {})
        discord = notifiers.setdefault("discord", {})
        discord["webhook_url"] = os.environ.get('WEBHOOK_STATUS', '')

        with open('config.json', 'w') as f:
            json.dump(config, f)

        print("‚úÖ config.json creado (v3)")
        if rawg_key:
            print("‚úÖ RAWG API key configurada")
        if itad_key:
            print("‚úÖ ITAD API key configurada")
        if ggdeals_key:
            print("‚úÖ GG.deals API key configurada")
        PYTHON_SCRIPT
    
    - name: üéÆ Ejecutar HunDea v3 ULTRA
      run: python hundea_v3_ultra.py
    
    - name: üìä Actualizar cache en el repo
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add cache.json
        git diff --quiet && git diff --staged --quiet || git commit -m "üîÑ Update cache [skip ci]"
        git push
