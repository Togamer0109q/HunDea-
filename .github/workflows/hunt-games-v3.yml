name: HunDeaBot v3.0 - Professional Gaming Deals Hunter

on:
  schedule:
    # Runs every 3 hours
    - cron: '0 */3 * * *'
  
  # Allow manual execution
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to hunt (all/console/pc/playstation/xbox/nintendo)'
        required: false
        default: 'all'

jobs:
  # Combined console hunt (efficient, runs all platforms together)
  hunt-consoles:
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'console' || github.event.inputs.platform == '' || github.event.inputs.platform == 'playstation' || github.event.inputs.platform == 'xbox' || github.event.inputs.platform == 'nintendo'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create config from secrets
        run: |
          cat > config.json << EOF
          {
            "webhooks": {
              "playstation": "${{ secrets.DISCORD_WEBHOOK_PS }}",
              "xbox": "${{ secrets.DISCORD_WEBHOOK_XBOX }}",
              "nintendo": "${{ secrets.DISCORD_WEBHOOK_NINTENDO }}",
              "pc_premium": "${{ secrets.DISCORD_WEBHOOK_PREMIUM }}",
              "pc_deals": "${{ secrets.DISCORD_WEBHOOK_DEALS }}",
              "pc_weekends": "${{ secrets.DISCORD_WEBHOOK_WEEKENDS }}",
              "pc_indie": "${{ secrets.DISCORD_WEBHOOK_INDIE }}"
            },
            "apis": {
              "rawg": "${{ secrets.RAWG_API_KEY }}",
              "psprices": {
                "region": "us",
                "platform": "ps5"
              },
              "xbox": {
                "region": "us",
                "language": "en-US"
              },
              "dekudeals": {
                "region": "us"
              }
            },
            "filters": {
              "playstation": {
                "min_discount": 50,
                "min_score": 3.5,
                "exclude_dlc": true,
                "include_ps_plus": true,
                "max_price": 60
              },
              "xbox": {
                "min_discount": 50,
                "min_score": 3.5,
                "exclude_dlc": true,
                "include_game_pass": true,
                "max_price": 60
              },
              "nintendo": {
                "min_discount": 40,
                "min_score": 3.5,
                "exclude_dlc": true,
                "indie_highlights": true,
                "max_price": 60
              },
              "pc": {
                "min_discount": 70,
                "min_score": 3.6,
                "max_price": 20
              }
            },
            "roles": {
              "playstation": "${{ secrets.ROL_PLAYSTATION }}",
              "xbox": "${{ secrets.ROL_XBOX }}",
              "nintendo": "${{ secrets.ROL_NINTENDO }}",
              "pc_premium": "${{ secrets.ROL_PREMIUM }}",
              "pc_deals": "${{ secrets.ROL_DEALS }}"
            },
            "features": {
              "enable_console_hunting": true,
              "enable_pc_hunting": ${{ github.event.inputs.platform != 'console' }},
              "enable_enrichment": true,
              "enable_caching": true
            }
          }
          EOF
      
      - name: Load cache
        uses: actions/cache@v3
        with:
          path: cache.json
          key: huntdea-cache-${{ github.run_number }}
          restore-keys: |
            huntdea-cache-
      
      - name: Run HunDeaBot v3.0
        run: |
          python hundea_v3.py
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: huntdea-logs-${{ github.run_number }}
          path: huntdea_v3.log
          retention-days: 7
      
      - name: Save cache
        if: always()
        uses: actions/cache/save@v3
        with:
          path: cache.json
          key: huntdea-cache-${{ github.run_number }}

  # Separate PC hunt (optional, for independent PC execution)
  hunt-pc:
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'pc'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create config (PC only)
        run: |
          cat > config.json << EOF
          {
            "webhooks": {
              "pc_premium": "${{ secrets.DISCORD_WEBHOOK_PREMIUM }}",
              "pc_deals": "${{ secrets.DISCORD_WEBHOOK_DEALS }}",
              "pc_weekends": "${{ secrets.DISCORD_WEBHOOK_WEEKENDS }}"
            },
            "apis": {
              "rawg": "${{ secrets.RAWG_API_KEY }}"
            },
            "features": {
              "enable_console_hunting": false,
              "enable_pc_hunting": true
            }
          }
          EOF
      
      - name: Run PC hunters
        run: |
          python hundea_v2.py  # Use existing v2 for PC only

  # Send status report
  send-status:
    runs-on: ubuntu-latest
    needs: [hunt-consoles]
    if: always()
    
    steps:
      - name: Send status to Discord
        if: github.event.inputs.platform == '' || !github.event.inputs.platform
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_STATUS }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ðŸ¤– HunDeaBot v3.0 Status",
                "description": "Hunt completed successfully",
                "color": 65280,
                "fields": [
                  {
                    "name": "â° Time",
                    "value": "'"$(date -u)"'",
                    "inline": true
                  },
                  {
                    "name": "ðŸ”„ Run Number",
                    "value": "#'"${{ github.run_number }}"'",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "HunDeaBot v3.0 - Professional Gaming Deals Hunter"
                }
              }]
            }'
